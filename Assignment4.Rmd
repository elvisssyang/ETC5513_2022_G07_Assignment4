---
title: "Report on Happiness up to 2022"
author:
- familyname: Yang 
  othernames: (Elvis) Zhixiang
  email: zyan0056@student.monash.edu
  correspondingauthor: true
  qualifications:  EBS Honours Student
- familyname: Wang
  othernames: Yiqi
  email: ywan0684@studnet.monash.edu
  qualifications: Master of BA Student
- familyname: You
  othernames: Xintong
  email: xyou0004@student.monash.edu
  correspondingauthor: true
  qualifications: Master of BA Student
phone: (03) 9905 2478
department: Department of\newline Econometrics &\newline Business Statistics
organization: Group 07 ETC5513
bibliography: references.bib
biblio-style: apa
linestretch: 1.5
output:
  monash::report:
    extra_dependencies: ["float","amsmath"]
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      eval = TRUE,
                      message = FALSE, 
                      warning = FALSE)
```




```{r}
library(tidyverse)
library(gganimate) 
library(GGally)
library(ggplot2) # Data visualization
library(readr) # read data files 
library(dplyr)
library(gridExtra)
library(RColorBrewer)
library(repr)
library(neuralnet)
library(ggpubr)
library(caTools)
library(rworldmap)# Draw world map 
library(rnaturalearth)
library(sf)
library(car)
library(kableExtra)
library(here)
library(lubridate)
library(cowplot)
library(janitor)
library(maps)
library(plotly)
require(wbstats)
library(lemon)
library(bookdown)
library(sp)

```




```{r}
data2015 <- read_csv('data/2015.csv')
data2016 <- read_csv('data/2016.csv')
data2017 <- read_csv('data/2017.csv')
data2018 <- read_csv('data/2018.csv')
data2019 <- read_csv('data/2019.csv')
data2020 <- read_csv('data/2020.csv')
data2021 <- read_csv('data/2021.csv')
data2022 <- read_csv('data/2022.csv')
```

```{r}
happiness_2020 <- read_csv("data/2020.csv")
happiness_2021 <- read_csv("data/2021.csv")
```


```{r dataPreparation}
data2015 <- data2015 %>% 
  select(Country,Region,`Happiness Score`,
         `Economy (GDP per Capita)`,
         `Health (Life Expectancy)`,
         Freedom) %>% 
  rename('Happiness_Score' = 'Happiness Score',
         'Economy' = 'Economy (GDP per Capita)',
         'Health' = 'Health (Life Expectancy)') %>% 
  mutate(Year = 2015)

data2016 <- data2016 %>% 
  select(Country,`Happiness Score`,
         `Economy (GDP per Capita)`,
         `Health (Life Expectancy)`,
         Freedom) %>% 
  rename('Happiness_Score' = 'Happiness Score',
         'Economy' = 'Economy (GDP per Capita)',
         'Health' = 'Health (Life Expectancy)') %>% 
  mutate(Year = 2016)

data2017 <- data2017 %>% 
  select(Country,Happiness.Score,
         Economy..GDP.per.Capita.,
         Health..Life.Expectancy.,
         Freedom) %>% 
  rename('Happiness_Score' = 'Happiness.Score',
         'Economy' = 'Economy..GDP.per.Capita.',
         'Health' = 'Health..Life.Expectancy.') %>% 
  mutate(Year = 2017)

data2018 <- data2018 %>% 
  select(`Country or region`,
         Score,
         `GDP per capita`,
         `Healthy life expectancy`,
         `Freedom to make life choices`) %>%
  rename('Country' = 'Country or region',
         'Happiness_Score' = 'Score',
         'Economy' = 'GDP per capita',
         'Health' = 'Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2018)

data2019 <- data2019 %>% 
  select(`Country or region`,
         Score,
         `GDP per capita`,
         `Healthy life expectancy`,
         `Freedom to make life choices`) %>%
  rename('Country' = 'Country or region',
         'Happiness_Score' = 'Score',
         'Economy' = 'GDP per capita',
         'Health' = 'Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2019)

data2020 <- data2020 %>% 
  select(`Country name`,
         `Ladder score`,
         `Explained by: Log GDP per capita`,
         `Explained by: Healthy life expectancy`,
         `Freedom to make life choices`) %>%
  rename('Country' = 'Country name',
         'Happiness_Score' = 'Ladder score',
         'Economy' = 'Explained by: Log GDP per capita',
         'Health' = 'Explained by: Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2020)

data2021 <- data2021 %>% 
  select(`Country name`,
         `Ladder score`,
         `Explained by: Log GDP per capita`,
         `Explained by: Healthy life expectancy`,
         `Freedom to make life choices`) %>%
  rename('Country' = 'Country name',
         'Happiness_Score' = 'Ladder score',
         'Economy' = 'Explained by: Log GDP per capita',
         'Health' = 'Explained by: Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2021)

data2022 <- data2022 %>% 
  select(Country,
         `Happiness score`,
         `Explained by: GDP per capita`,
         `Explained by: Healthy life expectancy`,
         `Explained by: Freedom to make life choices`) %>%
  rename('Happiness_Score' = 'Happiness score',
         'Economy' = 'Explained by: GDP per capita',
         'Health' = 'Explained by: Healthy life expectancy',
         'Freedom' = 'Explained by: Freedom to make life choices') %>% 
  mutate(Year = 2022,
         Happiness_Score = Happiness_Score/1000,
         Economy = str_replace(Economy,',','.') %>% as.numeric(),
         Health = str_replace(Health,',','.') %>% as.numeric(),
         Freedom = str_replace(Freedom,',','.') %>% as.numeric())
```


```{r dataPreparation2}
area <- data2015 %>% 
  select(Country,Region)

data2016 <- area %>% 
  left_join(data2016,by = 'Country')

data2017 <- area %>% 
  left_join(data2017,by = 'Country')

data2018 <- area %>% 
  left_join(data2018,by = 'Country')

data2019 <- area %>% 
  left_join(data2019,by = 'Country')

data2020 <- area %>% 
  left_join(data2020,by = 'Country')

data2021 <- area %>% 
  left_join(data2021,by = 'Country')

data2022 <- area %>% 
  left_join(data2022,by = 'Country')
```

```{r data_Preparation}
data1 <- bind_rows(data2015,data2016,data2017,data2018,
                 data2019,data2020,data2021,data2022)
```

\clearpage



# Introduction 

@rojas2010 stated that there are many factors may contributing happiness.They also mentioned that conceptions of happiness differ not only across people, but also across the culture, region etc. There are so many of factors that can influence the happiness of people. If we want to improve the happiness of people, we cannot stimulate all the variables that are relevant. Thus, an analysis on the world happiness report will help to figure the common key variable that influence the happiness of human beings and the situation of happiness around the world. Then, we can try to give a better scope of happiness at a worldwide level, especially after the pandemic.  


This report will analyse the happiness score of each country and different regions across the world to utilize the happiness at a world wide level. In order to capture the changes, there are various factors that relevant to the happiness score will be used to explain the variation of happiness score in different countries. 

Apart from this, @helliwell2021world stated that the global pandemic has significantly influenced the happiness of people in different regions. In considering of the pandemic, we also analyse the influence of COVID-19 to the rank of the happiness score in top countries and the variable relationships after the pandemic year 2020. 


In the modelling part, we will provide an detailed analysis of the model fits in various models. In this part,we will illustrate the most important variables in explaining the happiness score. Furthermore, we will also add two new variables together with the important variables to build up a multivariate linear model based on the 4 variables between 2016 to 2020 and explore their marginal effects on the happiness scores. 

However, due to the number of countries observed in different years are not consistent and variables are varies after year 2020, which might generate errors. Also, the new data are limited between 2016 to 2020, which can lead to sample selection bias. We will critically explain these issues in residual diagnostic part at the end of the modelling part. 

# Research Questions

The report will be divided into different sections to explore following research questions:


+ The influences of COVID-19 on the world happiness score and the correlations between happiness in 2021. 

+ The changes of happiness between 2015 and 2022 in different regions. 

+ The impact of economic situation and health status on happiness. 

+ The important variable in explaining happiness scores via different models and discover their marginal effects in a linear model. 



# Data

## Description 

Our data comes from Kaggle, which is a report of the World Happiness. In the eight datasets, the variables explaining the happiness score including Economy(measured in GDP per capita), Health status, Freedom, Generosity are consistent each year. Nevertheless, after year 2020, few new variables have been added and there are few changes with the existing variables. The happiness score is ranked from the highest to the lowest one and gained via an anonymous worldwide survey across different countries around the world. 

Apart from our existing data, we will also join two new datasets in the modelling part gained from the World Bank Data due to the potential issues in our existing dataset. More information will be discussed in the multivariate linear model part. 

## Pre-processing. 

The data gained from Kaggle is not clean. In this report, we tried to combine all the historical data with common factors, which are Economy, Health, Freedom, Generosity each year and drop the NA values. However, for specific yearly analysis after 2020, we decide to keep all the new variable in explaining the happiness score. 

In addition, two variable related to Consumer Price Index and Populations from the World Bank data will be joined across different countries in each year when we trying to build up our multivariate linear model. 




# Exploratory Data Analysis (World Happiness from 2015 to 2022)


In this part, we will investigate the trends of happiness score represented by region between 2015 and 2022. After this, we will analyse the impacts of annual health and economic status on happiness score.


Combined with my research questions, I consolidate all the datasets for each year between 2015 to 2022 into a new dataset, and then tease out the variables to use, which are year, region, happiness score, economy, and health.





## The development of the World Happiness 

@helliwell2012state stated that with the continuous progress of human society, the happiness index has become an important indicator for measuring the living standards across regions.  Meanwhile, people have also realized the importance to apply the happiness index in macroeconomic analysis. In the real world, the happiness index is related to many factors, it will also affect nearly all aspects of human activities. Thus, we will start with two research questions to explore the happiness index of the world.



## Research questions

+ How will happiness trends change between 2015 to 2022 in different regions? 


+ What is the relationship impacts of economic situation and health status to the happiness score?



## The trends in happiness 2015-2022

```{r trends, fig.cap = "Change of Happiness Score in Different Region", warning = FALSE,message = F}
p1 <- data1 %>% 
  select(Year,
         Happiness_Score,
         Region) %>% 
  
  group_by(Year,
           Region) %>% 
  summarise(Happiness_Score = mean(Happiness_Score,na.rm = T)) %>% 
  
  ungroup() %>%
  
  ggplot(aes(x = Year,y = Happiness_Score,group = Region,color = Region)) +
  geom_point() +
  geom_line() +
  scale_color_brewer(palette = 'Paired') +
  labs(y = 'Happiness Score',
       title = 'Change of Happiness Score in Different Region') +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5))
p1
```



From the Figure \@ref(fig:trends), we can see that the trend in all regions can be divided into three different levels of happiness score.  

We can see from the plot that South Asia and Sub-Saharan Africa remained at low level for the past few years. While Southern Asia countries started declining in 2017, Sub-Saharan Africa's happiness began to increase year by year after reaching the trough in 2016. In addition, the declining trend of happiness for people in Southeastern Asia may due to the population booming in these years. 

Moreover, the three regions had a relatively high scores are: Australia and New Zealand, North America, and Western Europe. We can see people living in these developed area feels happier than others, which may be due to the good social welfare, less stress and better working environment. Nevertheless, an interesting point to notice is that even there are many modern countries in Eastern Asia, people didn't really feel happy in the past few years. This may due to the living condition and working stresses are high from these Eastern Asian countries.


Then, the remaining regions are all centered in middle level. Among these regions, Central and Eastern Europe is the only region have an obvious increasing trend over the years, while the rest of the region is in a state of slightly fluctuating but generally stable trends.


Overall, we conclude that for those regions with relatively better economic situation and social welfare would generally lead to a higher happiness scores with less fluctuations than those regions with poor economic situation. 





## The relationship between economic situation and health status with the happiness in 2015-2022

People's understanding of happiness is inseparable from their own living conditions. In this section, we will also explore the relationship between happiness and economic and health status. 

From the figure \@ref(fig:VS), we can find that there is a positive correlation between economic status, health status and happiness score from 2015 to 2022, which is make sense that a better the economic status and health status will make people happier. 


There is an overall trend from 2015 to 2022 that the correlation of health and happiness is increasing over the years. Nevertheless, the correlation of economic situation is decreasing. This may due to the situation that people have better economic situation nowadays and they pay more attention on their health status.


From 2017 to 2018, the average influences of economic on happiness score increased slightly, while the influence of health on happiness score decreased slightly during this period.


On the other hand, from 2019 to 2022, the influence of the economic status on the happiness score is getting lower while the influence of the health on the happiness score has increased significantly especially after 2020, which maybe due to the pandemic that people care more about their health status. 


```{r VS, fig.cap = "Happiness Score vs Economy & Health", warning = FALSE,message = F}
data1 %>% 
  filter(!is.na(Year)) %>% 
  ggplot(aes(x = Economy,
             y = Health,
             color = Happiness_Score)) +
  geom_point(alpha = 0.7) +
  labs(color = 'Happiness Score',
       size = 'Happiness Score',
       title = 'Happiness Score vs Economy & Health') +
  facet_wrap(~Year,scales = 'free') +
  scale_color_viridis_c() +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        text = element_text(size = 8))
```




\newpage

\begin{table}
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Year} & \textbf{Intercept} & \textbf{Economy} & \textbf{Health} \\
\hline
2015          & 3.250              & 1.616            & 1.203           \\
2016          & 2.980              & 1.516            & 1.662           \\
2017          & 2.968              & 1.504            & 1.632           \\
2018          & 3.085              & 1.511            & 1.565           \\
2019          & 2.892              & 1.359            & 1.775           \\
2020          & 3.117              & 1.305            & 1.791           \\
2021          & 3.298              & 1.316            & 1.854           \\
2022          & 2.370              & 1.406            & 2.085           \\
\hline
\end{tabular}
\caption{A linear relationship between economic status and health status with happiness index each year}
\label{tab:table}
\end{table}




We also conducted an simple regression analysis. From the Table \@ref(tab:table), we can see the impact of economic situation on  the slope decreased very slowly from 1.616 to 1.406 over the years. On the contrary, the influence of health on happiness score changed a lot with the slope increased from 1.2 to 2.08. Through this simple linear regression analysis, we can also see that people gradually focus on their health status nowadays.




\newpage

# Exploratory data analysis (Pandemic Influences)


## Introduction

According to @helliwell2021world, economic situation, people's health and freedom have been severely affected across different countries since the outbreak of COVID-19 in 2020, which will directly impact the world. 

In the following research, the top 10 happiest countries in the world and their regions will be explored. Then, factors associated with the happiness score will be explored by analyzing the relation between happiness score and six selected indicators in 2021.


## What are the countries which ranks top 10 in happiness score since the COVID-19 outbreak?

```{r top10,fig.cap="The top 10 countries in happiness score since COVID-19"}

top10_2020 <- happiness_2020 %>%
  mutate(RANK = as.numeric(rownames(happiness_2020))) %>%
  select("RANK","Country name","Ladder score") %>%
  rename("Country" = "Country name",
         "Happiness score" = "Ladder score") %>%
  arrange(desc("Happiness score")) %>%
  head(n = 10)
top10_2021 <- happiness_2021 %>% 
  mutate(RANK = as.numeric(rownames(happiness_2021))) %>%
  select("RANK","Country name","Ladder score") %>% 
  rename("Country" = "Country name",
          "Happiness score" = "Ladder score") %>%
  arrange(desc("Happiness score"))  %>%
  head(n = 10)

g1 <- ggplot(top10_2020,
             aes(x=factor(Country,levels=Country),
                 y=RANK, color = Country))+
  geom_bar(stat="identity",
           width=0.5,
           fill= "white") +
  theme(axis.text.x = element_text(angle=90, vjust=0.6),
        legend.position="none") + 
  labs(title="Top10 Happiest Countries-2020",
       x="Country",y="Rank")
g2 <- ggplot(top10_2021,
             aes(x=factor(Country,levels=Country),
                 y=RANK, color = Country))+
  geom_bar(stat="identity",
           width=0.5,
           fill= "white") +  
  theme(axis.text.x = element_text(angle=90, vjust=0.6),
        legend.position="none") + 
  labs(title="Top10 Happiest Countries-2021",
       x="Country",y="Rank")

grid_arrange_shared_legend(g1, g2, ncol = 2,nrow= 1)
```

In the Figure \@ref(fig:top10), the top 10 countries in the World Happiness have not changed since 2020 despite the impact of COVID-19, while their ranks have changed slightly.

In addition, Finland has been the happiest country for two consecutive years in 2020 and 2021. We believe this is mainly due to the fact that Finland has a well structured social welfare and health care system [@lappi2006finland]. 

## The distribution of the top 10 countries on the world map in 2021
```{r top10map, fig.cap="The distribution of top 10 countries on the world map in 2021", results='hide'}
d1 <- data.frame(country = top10_2021$Country,
                 value = top10_2021$`Happiness score`)

n1 <- joinCountryData2Map(d1, 
                          joinCode="NAME", 
                          nameJoinColumn="country")
map_2021 <- mapCountryData(n1, 
               nameColumnToPlot="value", 
               mapTitle="The distribution of top 10 countries on the world map in 2021",
               colourPalette="terrain",
               oceanCol="white")
```

According to the Figure \@ref(fig:top10map), these countries are mainly northern and western European countries.Obviously, they are all developed countries which have a technologically advanced infrastructure and their economy is highly developed.  

So besides high economy, what are the other indicators that can affect happiness score?

## Relation between Happiness score and other indicators in 2021
```{r relation, fig.width = 12, fig.cap="Relation between Happiness score and 6 indicators in 2021"}
data_2021 <- happiness_2021 %>%
  rename("Happiness.Score" = "Ladder score",
         "GDP_Per_Capita" = "Logged GDP per capita",
         "Social_Support" = "Social support",
         "Healthy_Life_Expectancy" = "Healthy life expectancy",
         "Freedom" = "Freedom to make life choices",
         "Government_Corrution" = "Perceptions of corruption")

ggplotRegression <- function (x) {
  ggplot(x$model, aes_string(x = names(x$model)[2], 
                               y = names(x$model)[1])) +
    geom_point(shape = 1,
               size = 2,
               color="#0072B2")+
    stat_smooth(method = "lm", 
                col = "red",
                size = 1) +
    labs(title = paste("R2 = ",signif(summary(x)$r.squared, 3)))
}

gg1 <- ggplotRegression(lm(Happiness.Score ~ GDP_Per_Capita, data = data_2021))
gg2 <- ggplotRegression(lm(Happiness.Score ~ Social_Support, data = data_2021))
gg3 <- ggplotRegression(lm(Happiness.Score ~ Healthy_Life_Expectancy, data = data_2021))
gg4 <- ggplotRegression(lm(Happiness.Score ~ Freedom, data = data_2021))
gg5 <- ggplotRegression(lm(Happiness.Score ~ Generosity, data = data_2021))
gg6 <- ggplotRegression(lm(Happiness.Score ~ Government_Corrution, data = data_2021))

grid.arrange(gg1,gg2,gg3,gg4,gg5,gg6,ncol=2,nrow=3)
```

The 6 linear graphs in Figure \@ref(fig:relation) demonstrate the relationships between the happiness and 6 attributes of the countries in 2021. R-squared ($R^2$) represents the proportion of the variance for happiness that’s explained by an independent variable in the regression model. For example, in the graph on the upper left, its R-squared is 0.624, indicating that there are 62.4% of their happiness scores can be explained by their GDP. 

Therefore, we can see that both social support and health life expectancy explain happiness in a relatively high proportion which is 57.3% and 59% respectively. While freedom, generosity and trust in government corruption are not good in explaining happiness score.

To summarize, in this part we found the world's top 10 happiest countries are mainly concentrated in Northern and Western Europe in 2020 and 2021, which have high economic level and GDP. From the data of the world, the variables highly related to happiness are **GDP, social support and health life expectancy**.







```{r setup2}
# library(tidyverse)
# library(gganimate) 
# library(GGally)
# library(ggplot2) # Data visualization
# library(readr) # read data files 
# library(dplyr)
# library(gridExtra)
# library(RColorBrewer)
# library(repr)
# library(neuralnet)
# library(ggpubr)
# library(caTools)
# library(rworldmap)# Draw world map 
# library(rnaturalearth)
# library(sf)
# library(car)
# library(kableExtra)
# library(here)
# library(lubridate)
# library(cowplot)
# library(janitor)
# library(maps)
# library(plotly)
# require(wbstats)
# library(lemon)
# library(bookdown)
# library(sp)
```



```{r}
data2016 = read_csv("data/2016.csv")
data2017 = read_csv("data/2017.csv")
data2018= read_csv("data/2018.csv")
data2019 = read_csv("data/2019.csv")
data2020 = read_csv("data/2020.csv")



hap16 = read_csv("data/2016.csv")
hap17 = read_csv("data/2017.csv")
hap18 = read_csv("data/2018.csv")
hap18$`Perceptions of corruption` = as.numeric(hap18$`Perceptions of corruption`)
hap19 = read_csv("data/2019.csv")
hap20 = read_csv("data/2020.csv")


```

```{r data_Preparation2}

data2016 <- data2016 %>% 
  select(Country,`Happiness Score`,
         `Economy (GDP per Capita)`,
         `Health (Life Expectancy)`,
         Freedom, Generosity) %>% 
  rename('Happiness Score' = 'Happiness Score',
         'Economy' = 'Economy (GDP per Capita)',
         'Health' = 'Health (Life Expectancy)') %>% 
  mutate(Year = 2016)


data2017 <- data2017 %>% 
  select(Country,Happiness.Score,
         Economy..GDP.per.Capita.,
         Health..Life.Expectancy.,
         Freedom, Generosity) %>% 
  rename('Happiness Score' = 'Happiness.Score',
         'Economy' = 'Economy..GDP.per.Capita.',
         'Health' = 'Health..Life.Expectancy.') %>% 
  mutate(Year = 2017)

data2018 <- data2018 %>% 
  select(`Country or region`,
         Score,
         `GDP per capita`,
         `Healthy life expectancy`,
         `Freedom to make life choices`,
         `Generosity`) %>%
  rename('Country' = 'Country or region',
         'Happiness Score' = 'Score',
         'Economy' = 'GDP per capita',
         'Health' = 'Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2018)

data2019 <- data2019 %>% 
  select(`Country or region`,
         Score,
         `GDP per capita`,
         `Healthy life expectancy`,
         `Freedom to make life choices`,
         `Generosity`) %>%
  rename('Country' = 'Country or region',
         'Happiness Score' = 'Score',
         'Economy' = 'GDP per capita',
         'Health' = 'Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2019)

data2020 <- data2020 %>% 
  select(`Country name`,
         `Ladder score`,
         `Explained by: Log GDP per capita`,
         `Explained by: Healthy life expectancy`,
         `Freedom to make life choices`,
         `Generosity`) %>%
  rename('Country' = 'Country name',
         'Happiness Score' = 'Ladder score',
         'Economy' = 'Explained by: Log GDP per capita',
         'Health' = 'Explained by: Healthy life expectancy',
         'Freedom' = 'Freedom to make life choices') %>% 
  mutate(Year = 2020)

```

```{r}
dataall <- rbind(data2016, data2017, data2018, data2019, data2020)
```


```{r message=FALSE, warning=FALSE}
# Combine new data from world bank about CPI and Population up to 2020 


world_map = ne_countries(returnclass = 'sf')
cpi = read_csv("data/API_FP.CPI.TOTL.ZG_DS2_en_csv_v2.csv", skip = 4)
population = read_csv("data/API_SP.POP.TOTL_DS2_en_csv_v2.csv", skip = 4)
```


```{r}
# Wrangling the data to combine the new data with 2016-2020 happiness report data

temp <- hap16 %>% 
  dplyr::select(Country, `Happiness Score`, `Health` = `Health (Life Expectancy)`, `Economy` = `Economy (GDP per Capita)`) %>%
  mutate(year = 2016)

temp <- hap17 %>%
  dplyr::select(Country, `Happiness Score` = Happiness.Score, `Economy` = Economy..GDP.per.Capita., `Health` = Health..Life.Expectancy.) %>%
  mutate(year = 2017) %>%
  rbind(temp) 

temp <- hap18 %>%
  dplyr::select(Country = `Country or region`, `Happiness Score` = Score, `Health` = `Healthy life expectancy`, `Economy` = `GDP per capita`) %>%
  mutate(year = 2018) %>%
  rbind(temp)

temp <- hap19 %>%
  dplyr::select(Country = `Country or region`, `Happiness Score` = Score, `Health` = `Healthy life expectancy`, `Economy` = `GDP per capita`) %>%
  mutate(year = 2019) %>%
  rbind(temp) 

temp <- hap20 %>%
  dplyr::select(Country = `Country name`, `Happiness Score` = `Ladder score`, `Health` = `Healthy life expectancy`, `Economy` = `Explained by: Log GDP per capita`) %>%
  mutate(year = 2020)%>%
  rbind(temp)


hapall <- temp 

hapall <- population %>%
  dplyr::select(Country = `Country Name`, `2016`:`2020`) %>%
  gather(key = 'year', value = 'population', `2016`:`2020`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hapall) 

hapall <- cpi %>%
  dplyr::select(Country = `Country Name`, `2016`:`2020`) %>%
  gather(key = 'year', value = 'cpi', `2016`:`2020`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hapall) 


```


```{r}
# Remove the NA values 
narm_hapall = na.omit(hapall)

lognarm_hapall <- narm_hapall %>%
  mutate(log_score = log(`Happiness Score`), log_eco = log(Economy), log_health = log(Health), log_population = log(population)) %>% 
  dplyr::select(Country, year,log_score, log_eco, log_health, log_population, cpi) %>% 
  na.omit() %>% tibble()

lognarm_hapall <- do.call(data.frame,lapply(lognarm_hapall,function(x) replace(x, is.infinite(x), NA)))

```

\clearpage


# Modelling 


## What is the most important variable to explain the happiness score differences across different countries and years? 



In this part, since there are many different variables across each year in our data, we only keep the common variables  (Economy, Health, Generosity and Freedom) for these years to conduct our analysis. Before exploring how each factor will contribute to the happiness score, we first need to select a model that can represents our data well by running several tests on a few common models, listed in Table\ref{models}: 


\begin{table}[H]
\scalebox{0.8}{
\begin{tabular}{|c|c|}
\hline
\textless{}Possible Models \textgreater{} & \textless{}Model description \textgreater{}                                       \\
\hline\hline
\textbf{Multivariate Linear Model}       & Simple Linear regression with \textbf{multiple variables}                                \\
\hline
\textbf{Support Vector Machine Model}          & Use multiple learning algorithms (resampling and tree) to give us better results. \\
\hline
\textbf{Decision Tree Model}             & Binary tree model have control statement.                                         \\
\hline
\text{Random Forest Model}                     & Use multiple learning algorithms (resampling and tree) to give us better results.\\
\hline
\end{tabular}}
\caption{Model Description of our Possible Models}
\label{models}
\end{table}


We have divided the historical data (from 2015 to 2022) into two separated sets, a training test and a test set with different split ratio (*see* Figure \@ref(fig:training); Figure \@ref(fig:ggsp04) to \@ref(fig:ggsp07) *in appendix*). The test set will be used to examine which model has the best goodness-of-fit after building up the model with the training set. 




\newpage

```{r training, fig.cap="Model Training Split Ratio is 0.8"}
set.seed(1999)
happiness <- dataall %>% na.omit()

dataset <- happiness[2:6] %>% na.omit()
  
split <- sample.split(dataset$`Happiness Score`, SplitRatio = 0.8)


training_set <- subset(dataset, split == TRUE)
test_set <- subset(dataset, split == FALSE)

# Linear model 
regressor_lm = lm(formula = `Happiness Score` ~ . ,data = training_set )

# Linear plot 
y_pred_lm <- predict(regressor_lm, newdata = test_set)

Pred_Actual_lm <- as.data.frame(cbind(Prediction = y_pred_lm, Actual = test_set$`Happiness Score`))

gglm <- ggplot(Pred_Actual_lm, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Multivariate Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))




# SVM

library(e1071)
regressor_svm = svm(formula = `Happiness Score` ~ .,
                data = dataset,
                type = 'eps-regression',
                kernel = 'radial')


y_pred_svr = predict(regressor_svm,  newdata = test_set)

Pred_Actual_svr <- as.data.frame(cbind(Prediction = y_pred_svr, Actual = test_set$`Happiness Score`))


Pred_Actual_lmversus.svr <- cbind(Prediction.lm = y_pred_lm, Prediction.svr = y_pred_svr, Actual = test_set$Happiness.Score)

# SVR plot 
gg.svr <- ggplot(Pred_Actual_svr, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Support Vector Machine", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)),
        axis.title = element_text(family = "Helvetica", size = (10)))




# Decision Tree model 
# Fitting Decision Tree Regression to the dataset
library(rpart)
regressor_dt = rpart(formula = `Happiness Score` ~ .,
                  data = dataset,
                  control = rpart.control(minsplit = 10))




# Predicting a new result with Decision Tree Regression
y_pred_dt = predict(regressor_dt, newdata = test_set)

Pred_Actual_dt <- as.data.frame(cbind(Prediction = y_pred_dt, Actual = test_set$`Happiness Score`))


gg.dt <- ggplot(Pred_Actual_dt, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Decision Tree Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))



# Random Forest

library(randomForest)
set.seed(1234)
regressor_rf = randomForest(x = dataset[-1],
                         y = dataset$`Happiness Score`,
                         ntree = 1000)

# Predicting a new result with Random Forest Regression
y_pred_rf = predict(regressor_rf, newdata = test_set)

Pred_Actual_rf <- as.data.frame(cbind(Prediction = y_pred_rf, Actual = test_set$`Happiness Score`))


gg.rf <- ggplot(Pred_Actual_rf, aes(Actual, Prediction )) +
  geom_point() + theme_bw() + geom_abline() +
  labs(title = "Random Forest Regression", x = "Actual happiness score",
       y = "Predicted happiness score") +
  theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (15)), 
        axis.title = element_text(family = "Helvetica", size = (10)))




ggsp07 <- ggarrange(gglm, gg.svr, gg.dt, gg.rf, ncol = 2, nrow = 2) +
   labs(title = "Training and Test Split Ratio = 0.8" )


ggsp07
```




### Random Forest regression 

Random Forest Model has a variable selecting system (via bootstrapping) to decide the most significant tree and is able to reduce overwriting compared to the decision tree. With that said, the random forest is a strong modeling technique and more robust than other methods [@liberman2017]. We can see from the plot that this model has captured the data very well in the past few years based on various training sets (see Figure \@ref(fig:ggsp04) to \@ref(fig:ggsp07)). 

By checking the loading for each variable in the RF model, we get the order of importance in Table \@ref(tab:varimp). 


\newpage
```{r varimp}
regressor_rf[["importance"]] %>%
  as.data.frame() %>% 
  arrange(desc(IncNodePurity)) %>% 
  knitr::kable(caption = "Variable importance for Random Forest model", digits = 4) %>%
  kableExtra::kable_styling(latex_options = "striped")

```



Based on the result in Table \@ref(tab:varimp), the most important variable is Economy, followed by Health, Freedom and Generosity being the last. 




## Multivariate Linear Model Analysis. 


The RF model helps us to determine which variables to choose in the multivariate linear regression model. The advantage of using multivariate linear regression is that it can allow us to analyse the relationship between different variables in a statistical coherent way [@voxco2022],such as, marginal effects and percentage changes.



If using a classic linear model with all four variables, 

$$
\begin{aligned}
Happiness\ score=& Economy+Health+Generosity+Freedom
\end{aligned}
$$



They have similar impacts on explaining the happiness score and all of them are significant in Table \@ref(tab:without). Thus, it is hard to tease the importance of each variable out with this model. 




```{r without}

lm  <- lm(`Happiness Score`~  Health + Economy + Freedom + Generosity, data=dataall)

sumtable <- summary(lm)

sumtable$coefficients %>%
  knitr::kable(caption = "Linear regression model for happiness scores without new data", digits = 4) %>%
  kableExtra::kable_styling(latex_options = "striped")

```


As a result, we will drop the least insignificant two and add another two new variables, Consumer Price Index and the population size of each country, gained from the World Bank data from 2016 to 2022 [@world2022]. After matching the data for each country and drop the NA values, we can use the new dataset to construct a new Linear model. Nevertheless, due to the lack of data in 2021 and 2022, we can only use the data up to 2020.








$$
\begin{aligned}
\textbf{New Multivariate Linear Model with a natural log of score}:\\
log(score)= -4.6000-0.0008\ cpi+0.2591\ log(economy)\\-0.0026\ log(population)+0.0114\ log(health)+0.0032\ year
\end{aligned}
$$

```{r mle}


log_lm  <- lm(log_score~ cpi+ log_eco + log_population + log_health + year, data=lognarm_hapall) 

logsum <- summary(log_lm)


logsum$coefficients %>%
  knitr::kable(caption = "Multivariate Linear regression model for the log data with R-squared is 0.6076", digits = 4) %>%
  kableExtra::kable_styling(latex_options = "striped")

```



We can see in Table \@ref(tab:mle) that 60.76% of the variation in $log(score)$ can be explained by the model. It is noticeable that the economy status(GDP per capita) has the largest influence on the happiness scores than other variables. 



Besides, in econometric contexts, coefficients in the log-log model can be interpreted as the percentage change in dependent variable when there is a one percentage change increase in the regressor [@benoit2011]. 


For example: 


\begin{align*}
\frac{\Delta \text{ log(Happiness Score)}}{\Delta \text{ log(Economy)}} &\approx \frac{\Delta \text{ Happiness Score}}{\Delta \text{ Economy} }\frac{\text{Economy}}{\text{Happiness Score}}\\
&=\frac{\% \Delta \text{ Happiness Score}}{\% \Delta \text{ Economy}} \nonumber\\
&= \text{ME(Coefficient)}\nonumber\\
&= 0.2591
\end{align*}

Here, we can interpret that a 1% increase in Economy(measured in GDP per capita) will increase the happiness score by 0.2591%, keeping all other regressors constant. Similarly for the rest variables, a 1% percent increase in health will increase happiness by 0.0114%. On the contrary, we can see that an increase in population and CPI have negative impacts, which are -0.0026% for Population and -0.08 for CPI respectively.


















## Endogenity and Sample Selection Bias 

This model may have an endogenous problem, which is caused by omitting variables, as we only include 5 relevant variables in the model. There are some latent variables that affect the happiness score but are not included in this model such as education level and culture backgrounds. 




```{r worldmapall, results='hide', fig.cap= "Colour the country that have included in Worldmap"}
library(rnaturalearth)

map <-ne_countries(returnclass = "sf")

map$not_included = is.na(sapply(world_map$name, match, table = hapall$Country))

ggplot()+
  geom_sf(data = map, aes(fill = !not_included))+
  ggtitle("Country included in our dataset ", subtitle = "Red: Countries are not Included; Blue:Countries are included") +
  theme_bw()+
  theme(legend.position = 'bottom') +
  labs(fill = "Included")
```


Apparently, our model also has some bias in sample selection. In our model, data for  `r table(map$not_included)["TRUE"]` countries are not included, which are colored in red in Figure \@ref(fig:worldmapall). These missing countries are either sparsely populated or still in development, so the model is not revealing all information due to the sample selection bias. To solve this, sample selection models such as Heckman model or Tobit can be considered in Econometrics areas. 





\newpage

## Residual Diagonistic for the Regression Model 



From the Residual and Fitted plot in Figure \@ref(fig:resd), we can see it has a non-constant variance across the fitted value, which indicates the presence of Heteroskedasticity. Moreover, the error distribution (see Figure \@ref(fig:density)) and the Q-Q plot Figure (see  both Figure \@ref(fig:qq) and Figure \@ref(fig:inf)  also suggest the density of our model is somewhat to a normal distribution but influenced by outliers.

In conclusion, our model did a good job in explaining the relationships between happiness score and our selected aggressors even though there are still some limitations. 


```{r density,fig.cap="Distribution of the residual term"}
#Data Partitioning
set.seed(1999)
# function that return the residual plot 

residplot <- function(log_lm, nbreaks=30) {
  z <- rstudent(log_lm)
  hist(z, breaks=nbreaks, freq=FALSE, xlab="Studentized Residual",main="Distribution of Errors")
  rug(jitter(z), col="brown")
  curve(dnorm(x, mean=mean(z), sd=sd(z)), add=TRUE, col="red", lwd=1) 
  lines(density(z)$x, density(z)$y, col="green", lwd=2, lty=2) 
  legend("topright",legend = c( "Normal Curve", "Kernel Density Curve"),lty=1:2, col=c("red","green"), cex=.7)
}

g1 <- residplot(log_lm)

```


```{r resd, fig.cap="Residual vs Fitted value plot (with standardised residuals)"}
 plot(log_lm, which = 3) #residuals vs Fitted

```


```{r qq, fig.cap="Q-Q plot fitted model residual density vs normal distribution residual density"}
pp <- plot(log_lm, which = 2, main = "Normal Q-Q plot", sub = "In this Figure, the dotted line is Normal Distribution") 

```





```{r inf, fig.cap="Influence Plot, the bigger circle means outliers", results='hide'}

influencePlot(log_lm, main = "Influence Plot", sub = "Circle size is proportial to Cook's Distance")
```



\clearpage

# Conclusion

According the analysis, we have concluded that the Happiness Scores are closely related to the economic activities and health status. In those developed countries with better living and health conditions, people are generally feel happier than those people living in rural areas. 

On the other hand, we also found that the happiness scores for people living in Sub-Saharan and Southeast Asia are relatively low, which is mainly due to the poor economic development and harsh living environment [@helliwell2021world]. In terms of the happiness scores at region level, we also found that Europe is the most livable continent with majority of countries are above the average level. Even during the pandemic period, people living in European countries still feel happier than other regions.  

Apart from this, we also found that during the COVID-19 period between 2020 to 2021, the variables highly related to happiness are Health, Economy and Social Support and correlation between Health and Economy even stronger than before.

In addition, in our modelling part, over these years between 2015 to 2022, the most important variable in explaining the happiness scores across different countries are Economy (measured in GDP per capita) and Health. In our multivariate linear model analysis out of four variables Economy (measured in GDP per capital), CPI, Population and Health, it has been indicated that the Economy status is the most significant and essential factor to explaining the happiness score.

Furthermore, in terms of the marginal effect analysis we did in modelling part. Both Economy situation and Health status has a positive marginal effect on happiness score, while CPI and Population has a negative score. 

Nevertheless, our linear model analysis still limited due to the presence of hetroskedasticity, endogeneity bias and sample selection bias. Even though this model did a well job in explaining happiness score. These problems should also be concerned by further researches in modelling big  macroeconomic data globally. 











# Acknowledgement 

We shall never forget the hard works done by our lecturer Patricia on every Tuesday nights from Week 1 to Week 12. 

We will also remember our tutors Naveen and Fan. They performed hard works on our tutorials and gave us nice recommendations during the presentation session. 

Moreover, we'd like to thank all EBS scholars from **Monash University** for their excellent `monash` package produced such a nice report template. 

Without any of their help, our works could not get finished so smoothly. 

Overall, I'd also like to thank those package developers who fight for the open source software, which made us easier to plot so many beautiful plots.

Here are the lists of packages we used: 



\clearpage
# Appendix

\begin{align*}
\intertext{We here take the Economy Situation (measured in GDP per capita) as an example:}
\frac{\partial \text{log(Happiness Score)}}{\partial \text{log(Economy)}} &= \text{ME(Coefficient)}\\
\intertext{From (1) we can say, when other variables remain constant }\nonumber \\
\Delta \text{ log(Happiness Score)} &= \text{ME(Coefficient)} \times \Delta \text{ log(Economy)}\\
\intertext{By using the infinite approaching approximation of log function, we can know}\nonumber\\
log(x_0 + \Delta x) - log(x_0) &\approx log(x_0) + log'(x_0)\Delta x - log(x_0)\\
&=  \frac{\Delta x}{x_0} = \text{percentage change in x}\nonumber\\
\intertext{Therefore}\nonumber\\
\frac{\Delta \text{ log(Happiness Score)}}{\Delta \text{ log(Economy)}} &\approx \frac{\Delta \text{ Happiness Score}}{\Delta \text{ Economy} }\frac{\text{Economy}}{\text{Happiness Score}}\\
&=\frac{\% \Delta \text{ Happiness Score}}{\% \Delta \text{ Economy}} \nonumber\\
&= \text{ME(Coefficient)}\nonumber
\end{align*}




```{r ggsp04, fig.cap = "Models' performance under the training test split ratio = 0.4", out.width="70%",fig.align='center'}
knitr::include_graphics("figure/ggsp04.png")
```


```{r ggsp05, fig.cap = "Models' performance under the training test split ratio = 0.5", out.width="70%",fig.align='center'}
knitr::include_graphics("figure/ggsp05.png")
```



```{r ggsp06, fig.cap = "Models' performance under the training test split ratio = 0.6", out.width="70%",fig.align='center'}
knitr::include_graphics("figure/ggsp06.png")
```


```{r ggsp07, fig.cap = "Models' performance under the training test split ratio = 0.7", out.width="70%",fig.align='center'}
knitr::include_graphics("figure/ggsp07.png")
```


\clearpage
